<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>War Game Online - ロビー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>
<body>
  <h1>War Game Online - オンラインロビー</h1>

  <section>
    <h2>ロビー / 自動マッチング（8人 または 3分で開始）</h2>
    <p>
      ロビーに参加すると、<strong>参加人数が8人に達する</strong>か、
      <strong>最初のプレイヤーが入室してから3分経過</strong>したタイミングで
      自動的にマッチングされます。
    </p>

    <!-- 名前入力＆ロビー参加ボタン -->
    <div style="margin-top: 8px;">
      <label>
        プレイヤー名（ロビー用）:
        <input id="lobbyPlayerNameInput" type="text" placeholder="例: あああ" />
      </label>
      <button id="joinLobbyBtn">ロビーに参加（キューに入る）</button>
    </div>

    <!-- 自分のUIDやロビー状態 -->
    <div style="margin-top: 8px;">
      <p>自分のロビー用 UID: <span id="myLobbyUidSpan">(未生成)</span></p>
      <p>ロビー状態: <span id="lobbyStatusSpan">-</span></p>
      <p>マッチ開始まで: <span id="lobbyTimerSpan">-</span></p>
      <p>現在の人数: <span id="lobbyCountSpan">0</span> / 8</p>
    </div>

    <!-- プレイヤー一覧 -->
    <div style="margin-top: 8px;">
      <h3>ロビー内プレイヤー一覧（matching/waitingRoom）</h3>
      <ul id="lobbyPlayersList">
        <li>(まだ誰もいません)</li>
      </ul>
    </div>

    <!-- 自分のプレイヤー番号 & gameId -->
    <div style="margin-top: 8px;">
      <p>ロビー制マッチでの自分のプレイヤー番号: <span id="myLobbyIndexSpan">-</span></p>
      <p>ロビー制マッチで割り当てられた gameId: <span id="myLobbyGameIdSpan">(まだなし)</span></p>
    </div>
  </section>

  <!-- ロビー用スクリプト -->
  <script type="module">
    import {
      joinMatchQueue,
      subscribeWaitingRoom,
      subscribeMyGame,
    } from "./src/matching.js";

    // ===== DOM 取得 =====
    const lobbyPlayerNameInput = document.getElementById("lobbyPlayerNameInput");
    const joinLobbyBtn = document.getElementById("joinLobbyBtn");
    const myLobbyUidSpan = document.getElementById("myLobbyUidSpan");
    const lobbyStatusSpan = document.getElementById("lobbyStatusSpan");
    const lobbyTimerSpan = document.getElementById("lobbyTimerSpan");
    const lobbyCountSpan = document.getElementById("lobbyCountSpan");
    const lobbyPlayersList = document.getElementById("lobbyPlayersList");
    const myLobbyIndexSpan = document.getElementById("myLobbyIndexSpan");
    const myLobbyGameIdSpan = document.getElementById("myLobbyGameIdSpan");

    // ===== ロビー用 UID をローカルに保持 =====
    const LOBBY_UID_KEY = "wgo_lobby_uid_v1";
    let lobbyUid = localStorage.getItem(LOBBY_UID_KEY);
    if (!lobbyUid) {
      lobbyUid =
        (window.crypto && window.crypto.randomUUID && window.crypto.randomUUID()) ||
        "uid-" + Math.random().toString(36).slice(2);
      localStorage.setItem(LOBBY_UID_KEY, lobbyUid);
    }
    myLobbyUidSpan.textContent = lobbyUid;

    // ===== カウントダウン用の状態 =====
    let firstJoinedMs = null; // 最初に入った人の joinedAt(ms)
    let timerId = null;

    function formatJoinedTime(ms) {
      const d = new Date(ms);
      return d.toLocaleTimeString("ja-JP", {
        hour: "2-digit",
        minute: "2-digit",
        second: "2-digit",
      });
    }

    function updateTimer() {
      if (!firstJoinedMs) {
        lobbyTimerSpan.textContent = "-";
        return;
      }

      const TOTAL_MS = 3 * 60 * 1000; // 3分
      const elapsed = Date.now() - firstJoinedMs;
      const remaining = TOTAL_MS - elapsed;

      if (remaining <= 0) {
        lobbyTimerSpan.textContent =
          "3分経過（サーバー側でマッチング判定中…）";
        return;
      }

      const sec = Math.floor(remaining / 1000);
      const min = Math.floor(sec / 60);
      const s = sec % 60;
      lobbyTimerSpan.textContent =
        `${min}:${String(s).padStart(2, "0")} 後に自動マッチング（1人目参加から）`;
    }

    function startTimerIfNeeded() {
      if (!timerId) {
        timerId = setInterval(updateTimer, 1000);
      }
      updateTimer();
    }

    function stopTimer() {
      if (timerId) {
        clearInterval(timerId);
        timerId = null;
      }
      firstJoinedMs = null;
      lobbyTimerSpan.textContent = "-";
    }

    // ===== ロビー状態を購読 =====
    subscribeWaitingRoom((data) => {
      const players = Array.isArray(data.players) ? data.players : [];
      lobbyCountSpan.textContent = String(players.length);

      // joinedAt 昇順で並べ替え
      const sorted = [...players].sort((a, b) => {
        const ta =
          typeof a.joinedAt === "number"
            ? a.joinedAt
            : Number.MAX_SAFE_INTEGER;
        const tb =
          typeof b.joinedAt === "number"
            ? b.joinedAt
            : Number.MAX_SAFE_INTEGER;
        return ta - tb;
      });

      // 最初の joinedAt を取得（タイマー用）
      const validTimes = sorted
        .map((p) =>
          typeof p.joinedAt === "number" ? p.joinedAt : null
        )
        .filter((v) => v != null);

      if (validTimes.length > 0) {
        firstJoinedMs = Math.min(...validTimes);
        startTimerIfNeeded();
        lobbyStatusSpan.textContent = "ロビー待機中…";
      } else {
        stopTimer();
        lobbyStatusSpan.textContent = "プレイヤー待機中…";
      }

      // プレイヤー一覧を描画
      lobbyPlayersList.innerHTML = "";
      if (sorted.length === 0) {
        const li = document.createElement("li");
        li.textContent = "(まだ誰もいません)";
        lobbyPlayersList.appendChild(li);
      } else {
        sorted.forEach((p) => {
          const li = document.createElement("li");
          const isMe = p.uid === lobbyUid;

          let timeLabel = "[時刻不明]";
          if (typeof p.joinedAt === "number") {
            timeLabel = "[" + formatJoinedTime(p.joinedAt) + "]";
          }

          li.textContent =
            `${p.name ?? "NoName"} ${timeLabel}` +
            (isMe ? " ← あなた" : "");
          lobbyPlayersList.appendChild(li);
        });
      }

      // 自分のプレイヤー番号（1始まり）
      const myIndex = sorted.findIndex((p) => p.uid === lobbyUid);
      myLobbyIndexSpan.textContent = myIndex >= 0 ? String(myIndex + 1) : "-";
    });

    // ===== 自分が割り当てられたゲームを購読 =====
    subscribeMyGame(lobbyUid, (game) => {
      if (!game) {
        myLobbyGameIdSpan.textContent = "(まだなし)";
        return;
      }
      myLobbyGameIdSpan.textContent = game.id ?? "(ID不明)";
    });

    // ===== 「ロビーに参加」ボタン =====
    joinLobbyBtn.addEventListener("click", async () => {
      const name = lobbyPlayerNameInput.value.trim();
      if (!name) {
        alert("プレイヤー名を入力してください。");
        return;
      }

      lobbyStatusSpan.textContent = "ロビー参加リクエスト送信中…";

      try {
        await joinMatchQueue({
          uid: lobbyUid,
          displayName: name,
        });
        lobbyStatusSpan.textContent = "ロビー参加 OK（待機中）";
      } catch (err) {
        console.error(err);
        lobbyStatusSpan.textContent =
          "ロビー参加エラー: " + String(err);
        alert("ロビーへの参加中にエラーが発生しました。コンソールを確認してください。");
      }
    });
  </script>
</body>
</html>
